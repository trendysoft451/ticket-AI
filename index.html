<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Frais — GED + OCR + Écritures</title>

  <style>
    :root{
      --bg:#f2f2f7;--card:rgba(255,255,255,.78);--card-solid:#fff;--border:rgba(60,60,67,.18);
      --text:#111;--sub:rgba(60,60,67,.70);--accent:#0a84ff;--accent-2:#34c759;--danger:#ff3b30;
      --shadow:0 10px 30px rgba(0,0,0,.08);--shadow-soft:0 1px 0 rgba(0,0,0,.04);
      --radius:20px;--radius-sm:14px;--blur:18px;--ring:0 0 0 4px rgba(10,132,255,.18);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#000;--card:rgba(28,28,30,.78);--card-solid:#1c1c1e;--border:rgba(84,84,88,.40);
        --text:#f2f2f7;--sub:rgba(235,235,245,.68);--accent:#0a84ff;--accent-2:#32d74b;--danger:#ff453a;
        --shadow:0 18px 40px rgba(0,0,0,.40);--shadow-soft:0 1px 0 rgba(255,255,255,.06);
        --ring:0 0 0 4px rgba(10,132,255,.25);
      }
    }
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(10,132,255,.22), transparent 55%),
        radial-gradient(900px 500px at 90% 15%, rgba(50,215,75,.18), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","Segoe UI",Roboto,Arial;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }
    .container{max-width:820px;margin:0 auto;padding:max(16px, env(safe-area-inset-top)) 16px calc(28px + env(safe-area-inset-bottom))}
    .topbar{
      position:sticky;top:0;z-index:10;padding:10px 0 14px;
      backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));
      background:linear-gradient(to bottom, rgba(255,255,255,.65), rgba(255,255,255,0));
    }
    @media (prefers-color-scheme: dark){
      .topbar{background:linear-gradient(to bottom, rgba(0,0,0,.65), rgba(0,0,0,0));}
    }
    .h1{font-size:22px;font-weight:900;margin:6px 0 4px;letter-spacing:-0.02em}
    .sub{font-size:13px;color:var(--sub);margin:0;line-height:1.4}
    .grid{display:grid;gap:14px;margin-top:14px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow-soft);
      backdrop-filter:blur(var(--blur));
      -webkit-backdrop-filter:blur(var(--blur));
    }
    .section-title{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      height:22px;min-width:22px;padding:0 10px;
      border:1px solid var(--border);border-radius:999px;
      background:rgba(255,255,255,.6);color:var(--sub);
      font-size:12px;font-weight:800;
    }
    @media (prefers-color-scheme: dark){ .pill{background:rgba(28,28,30,.6);} }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){ .row{grid-template-columns:1fr} }
    label{display:grid;gap:6px;font-size:12px;color:var(--sub);letter-spacing:.01em}
    input,select,textarea,button{font:inherit}
    input,select,textarea{
      padding:12px;border-radius:var(--radius-sm);
      border:1px solid var(--border);
      background:var(--card-solid);color:var(--text);
      outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
    }
    input:focus,select:focus,textarea:focus{border-color:rgba(10,132,255,.55);box-shadow:var(--ring)}
    input::placeholder,textarea::placeholder{color:rgba(60,60,67,.45)}
    @media (prefers-color-scheme: dark){
      input::placeholder,textarea::placeholder{color:rgba(235,235,245,.35)}
    }
    textarea{
      min-height:240px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;white-space:pre;
    }
    .btn{
      appearance:none;border:none;border-radius:16px;
      padding:12px 14px;font-weight:900;font-size:16px;
      background:var(--accent);color:#fff;
      box-shadow:var(--shadow);cursor:pointer;
      transition:transform .06s ease, filter .15s ease, box-shadow .15s ease;
      touch-action:manipulation;
    }
    .btn:active{transform:scale(.99);filter:brightness(.96)}
    .btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}
    .hint{font-size:12px;color:var(--sub);line-height:1.4;margin-top:2px}
    .err{font-size:12px;color:var(--danger);white-space:pre-wrap;line-height:1.35}
    .ok{font-size:12px;color:var(--accent-2);white-space:pre-wrap;line-height:1.35}
    .hidden{display:none!important}
  </style>
</head>

<body>
<div class="container">
  <div class="topbar">
    <div id="title" class="h1"></div>
    <p id="subtitle" class="sub"></p>
  </div>

  <div id="admin" class="grid hidden">
    <div class="card grid">
      <div class="section-title">
        <span class="pill">Admin</span>
        <div>
          <div style="font-weight:900">Connexion CNX</div>
          <div class="hint">Option 1 : configure plutôt via variables Render.</div>
        </div>
      </div>

      <label>URL API (base) — ex: https://isuiteacd.suiteexpert.fr/cnx/api
        <input id="baseUrl" placeholder="https://isuiteacd.suiteexpert.fr/cnx/api">
      </label>

      <div class="row">
        <label>Identifiant
          <input id="identifiant" placeholder="...">
        </label>
        <label>Mot de passe
          <input id="motdepasse" type="password" placeholder="...">
        </label>
      </div>

      <button class="btn" id="saveAdmin">Enregistrer</button>
      <div class="err" id="adminErr"></div>
      <div class="ok" id="adminOk"></div>
    </div>
  </div>

  <div id="user" class="grid hidden">
    <div class="card grid">
      <div class="section-title">
        <span class="pill">1</span>
        <div>
          <div style="font-weight:900">PDF → GED + OCR</div>
          <div class="hint">Upload en GED (arbo 945) puis OCR pour pré-remplir les champs.</div>
        </div>
      </div>

      <label>PDF à envoyer en GED (et OCR)
        <input id="pdfGed" type="file" accept="application/pdf">
      </label>

      <button class="btn" id="uploadGed">Envoyer + OCR</button>
      <div class="err" id="gedErr"></div>
      <div class="ok" id="gedOk"></div>

      <label>Id GED (référence)
        <input id="referenceGedId" placeholder="(rempli automatiquement)" readonly>
      </label>
    </div>

    <div class="card grid">
      <div class="section-title">
        <span class="pill">2</span>
        <div>
          <div style="font-weight:900">Écritures</div>
          <div class="hint">Vérifie/ajuste puis génère le JSON (ReferenceGed = Id GED).</div>
        </div>
      </div>

      <div class="row">
        <label>Journal
          <input id="journal" value="AC">
        </label>
        <label>Compte fournisseur (auto)
          <input id="compteFournisseur" readonly>
        </label>
      </div>

      <div class="row">
        <label>Catégorie
          <select id="categorie"></select>
        </label>
        <label>TVA (taux)
          <select id="tvaRate"></select>
        </label>
      </div>

      <div class="row">
        <label>Date ticket (YYYY-MM-DD)
          <input id="dateTicket" placeholder="2026-02-20">
        </label>
        <label>Numéro ticket
          <input id="numeroTicket" placeholder="ex: 000123">
        </label>
      </div>

      <label>Raison sociale (libellé)
        <input id="raisonSociale" placeholder="ex: UBER BV">
      </label>

      <div class="row">
        <label>Montant TTC
          <input id="ttc" inputmode="decimal" placeholder="ex: 12,34">
        </label>
        <label>Montant HT
          <input id="ht" inputmode="decimal" placeholder="ex: 11,22">
        </label>
      </div>

      <label>Montant TVA
        <input id="tvaMontant" inputmode="decimal" placeholder="ex: 1,12">
      </label>

      <button class="btn" id="submit">Générer Écritures</button>
      <div class="err" id="err"></div>
    </div>

    <div class="card grid">
      <div class="section-title">
        <span class="pill">JSON</span>
        <div>
          <div style="font-weight:900">Résultat</div>
          <div class="hint">Copie/colle le JSON généré.</div>
        </div>
      </div>
      <textarea id="result" readonly></textarea>
    </div>
  </div>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const isAdmin = qs.get("admin") === "1";
  const el = (id) => document.getElementById(id);

  const CATEGORIES = [
    { key: "petites_fournitures", label: "Petites fournitures et entretien", allowedVat: ["20","10"] },
    { key: "papeterie", label: "Papeterie", allowedVat: ["20"] },
    { key: "carburant", label: "Carburant", allowedVat: ["20"] },
    { key: "repas_pro", label: "Repas pro", allowedVat: ["10"] },
    { key: "repas", label: "Repas", allowedVat: ["0"] },
    { key: "peages", label: "Péages", allowedVat: ["20"] },
    { key: "parking", label: "Parking", allowedVat: ["20"] }
  ];

  function compteFromCategory(catKey){
    switch(catKey){
      case "repas_pro":
      case "repas": return "FREPAS";
      case "carburant": return "FCARBU";
      case "parking": return "FPARKING";
      case "peages": return "FPEAGE";
      case "petites_fournitures":
      case "papeterie":
      default: return "FDIVERS";
    }
  }

  function fillCategories() {
    el("categorie").innerHTML = CATEGORIES.map(c => `<option value="${c.key}">${c.label}</option>`).join("");
  }

  function fillVatOptions() {
    const cat = CATEGORIES.find(c => c.key === el("categorie").value);
    const allowed = (cat && cat.allowedVat) ? cat.allowedVat : ["20","10","0"];
    el("tvaRate").innerHTML = allowed.map(r => `<option value="${r}">${r}%</option>`).join("");
  }

  function setSelectValue(selectEl, value){
    const opt = [...selectEl.options].find(o => o.value === value);
    if (opt) selectEl.value = value;
  }

  function toNumOrNull(v){
    const s = String(v||"").replace(",", ".").trim();
    if (!s) return null;
    const x = Number(s);
    return Number.isFinite(x) ? x : null;
  }

  if (isAdmin) {
    el("title").textContent = "Admin — Connexion API";
    el("subtitle").textContent = "Option 1 recommandée : variables Render. (Cette page sert surtout en dev.)";
    el("admin").classList.remove("hidden");

    el("saveAdmin").addEventListener("click", async () => {
      el("adminErr").textContent = "";
      el("adminOk").textContent = "";

      const payload = {
        baseUrl: el("baseUrl").value.trim(),
        identifiant: el("identifiant").value.trim(),
        motdepasse: el("motdepasse").value
      };

      try {
        const resp = await fetch("/api/admin/config", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const out = await resp.json();
        if (!resp.ok) throw new Error(out.error || "Erreur");
        el("adminOk").textContent = "OK enregistré (mémoire serveur).";
      } catch (e) {
        el("adminErr").textContent = String(e.message || e);
      }
    });

  } else {
    el("title").textContent = "Frais — GED + OCR + Écritures";
    el("subtitle").textContent = "1) Upload PDF en GED + OCR (pré-remplissage)  2) Génère le JSON d'écritures.";
    el("user").classList.remove("hidden");

    fillCategories();
    fillVatOptions();
    el("compteFournisseur").value = compteFromCategory(el("categorie").value);

    el("categorie").addEventListener("change", () => {
      fillVatOptions();
      el("compteFournisseur").value = compteFromCategory(el("categorie").value);
    });

    el("uploadGed").addEventListener("click", async () => {
      el("gedErr").textContent = "";
      el("gedOk").textContent = "";

      const f = el("pdfGed").files && el("pdfGed").files[0];
      if (!f) return el("gedErr").textContent = "Choisis un PDF d'abord.";

      const form = new FormData();
      form.append("pdf", f, f.name || "ticket.pdf");

      try {
        const resp = await fetch("/api/ged/upload", { method:"POST", body: form });
        const out = await resp.json();
        if (!resp.ok) throw new Error(out.error || "Erreur upload GED");

        el("referenceGedId").value = out.gedId;
        el("gedOk").textContent = "PDF envoyé. Id GED = " + out.gedId;

        const ex = out.extraction || {};
        if (ex.date_document) el("dateTicket").value = ex.date_document;
        if (ex.numero_ticket) el("numeroTicket").value = ex.numero_ticket;
        if (ex.raison_sociale) el("raisonSociale").value = ex.raison_sociale;
        if (typeof ex.montant_ttc === "number") el("ttc").value = String(ex.montant_ttc).replace(".", ",");
        if (typeof ex.montant_ht === "number") el("ht").value = String(ex.montant_ht).replace(".", ",");
        if (typeof ex.montant_tva === "number") el("tvaMontant").value = String(ex.montant_tva).replace(".", ",");

        const sug = out.suggestion || {};
        if (sug.categorie_ui) {
          setSelectValue(el("categorie"), sug.categorie_ui);
          fillVatOptions();
        }
        if (sug.tva_rate) {
          setSelectValue(el("tvaRate"), sug.tva_rate);
        }

        // Compte fournisseur EXACT
        if (sug.journal_ttc) {
          el("compteFournisseur").value = sug.journal_ttc; // FREPAS/FCARBU/FPARKING/FPEAGE/FDIVERS
        } else {
          el("compteFournisseur").value = compteFromCategory(el("categorie").value);
        }

      } catch (e) {
        el("gedErr").textContent = String(e.message || e);
      }
    });

    el("submit").addEventListener("click", async () => {
      el("err").textContent = "";
      el("result").value = "";

      const referenceGedId = el("referenceGedId").value.trim();
      if (!referenceGedId) return el("err").textContent = "Uploade d'abord le PDF en GED.";

      const meta = {
        journal: el("journal").value.trim(),
        compteFournisseur: el("compteFournisseur").value.trim(),
        referenceGedId,
        categorie_ui: el("categorie").value,
        tva_rate: el("tvaRate").value,
        date_ticket: el("dateTicket").value.trim() || null,
        numero_ticket: el("numeroTicket").value.trim() || null,
        raison_sociale: el("raisonSociale").value.trim() || null,
        montant_ttc: toNumOrNull(el("ttc").value),
        ht: toNumOrNull(el("ht").value),
        tva_montant: toNumOrNull(el("tvaMontant").value)
      };

      if (!meta.journal) return el("err").textContent = "Journal obligatoire";
      if (!meta.compteFournisseur) return el("err").textContent = "Compte fournisseur manquant";

      const form = new FormData();
      form.append("meta", JSON.stringify(meta));

      try {
        const resp = await fetch("/api/receipts/process", { method:"POST", body: form });
        const out = await resp.json();
        if (!resp.ok) throw new Error(out.error || "Erreur");
        el("result").value = JSON.stringify(out, null, 2);
      } catch (e) {
        el("err").textContent = String(e.message || e);
      }
    });
  }
</script>
</body>
</html>
