<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tikeo Scan</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#f4f7f9;color:#333}
    .container{max-width:600px;margin:20px auto;padding:15px}
    .card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.1);margin-bottom:20px}
    .btn-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    button{padding:12px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;background:#007bff;color:#fff}
    button.secondary{background:#6c757d}
    button.ok{background:#28a745}
    .hidden{display:none}
    video, canvas { width: 100%; border-radius: 8px; background:#000 }
    input, select { width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:6px; box-sizing:border-box}
    .status{padding:10px; border-radius:6px; margin:10px 0; font-size:14px}
    .success{background:#e8f5e9; color:#2e7d32}
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <h3>1Ô∏è‚É£ Source du document</h3>
    <div class="btn-grid">
      <button id="btnCam">üì∏ Cam√©ra</button>
      <button id="btnFile" class="secondary">üìÅ PDF</button>
    </div>
    <input type="file" id="fileInput" accept="application/pdf" class="hidden">
    
    <div id="camPanel" class="hidden" style="position:relative; margin-top:15px">
      <video id="video" playsinline muted></video>
      <canvas id="overlay" style="position:absolute; top:0; left:0"></canvas>
      <div id="camMsg" style="text-align:center; color:#007bff; font-weight:bold">Initialisation...</div>
    </div>

    <div id="previewPanel" class="hidden">
      <p><b>Aper√ßu du document :</b></p>
      <canvas id="outCanvas"></canvas>
      <button id="btnUpload" class="ok" style="width:100%; margin-top:10px">üöÄ Analyser le document</button>
    </div>
    <div id="ocrStatus" class="status hidden"></div>
  </div>

  <div class="card">
    <h3>2Ô∏è‚É£ D√©tails comptables</h3>
    <label>Dossier: <input id="viewDossier" readonly></label>
    <div class="btn-grid">
      <input id="dateDoc" type="date">
      <input id="ttc" placeholder="Montant TTC">
    </div>
    <input id="raison" placeholder="Raison sociale">
    <button id="btnSubmit" class="ok" style="width:100%">‚úÖ Valider l'√©criture</button>
  </div>
</div>

<script src="https://docs.opencv.org/4.x/opencv.js" async></script>
<script src="https://unpkg.com/jscanify@1.2.0/dist/jscanify.min.js" defer></script>

<script>
  const $ = id => document.getElementById(id);
  let scanner, stream, loop, docBlob;

  // --- CAMERA LOGIC ---
  $('btnCam').onclick = async () => {
    $('camPanel').classList.remove('hidden');
    scanner = new jscanify();
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    $('video').srcObject = stream;
    $('video').play();
    
    const ctx = $('overlay').getContext('2d');
    loop = setInterval(() => {
      if (!$('video').videoWidth) return;
      $('overlay').width = $('video').videoWidth;
      $('overlay').height = $('video').videoHeight;
      ctx.drawImage($('video'), 0, 0);
      const mat = cv.imread($('video'));
      const contour = scanner.findPaperContour(mat);
      if (contour) {
        scanner.highlightPaper($('overlay'), { color: '#00ff00', thickness: 5 });
        if (++this.stab > 10) capture(contour);
      } else { this.stab = 0; }
      mat.delete();
    }, 100);
  };

  function capture(contour) {
    clearInterval(loop);
    const canvas = scanner.extractPaper($('video'), 800, 1100, contour);
    $('outCanvas').width = 800; $('outCanvas').height = 1100;
    $('outCanvas').getContext('2d').drawImage(canvas, 0, 0);
    canvas.toBlob(b => docBlob = b, 'image/jpeg', 0.9);
    $('previewPanel').classList.remove('hidden');
    stream.getTracks().forEach(t => t.stop());
    $('camPanel').classList.add('hidden');
  }

  // --- FILE LOGIC ---
  $('btnFile').onclick = () => $('fileInput').click();
  $('fileInput').onchange = e => {
    docBlob = e.target.files[0];
    $('previewPanel').classList.remove('hidden');
    $('outCanvas').classList.add('hidden');
  };

  // --- UPLOAD & OCR ---
  $('btnUpload').onclick = async () => {
    const fd = new FormData();
    fd.append('pdf', docBlob, docBlob.name || "scan.jpg");
    $('ocrStatus').className = "status"; $('ocrStatus').textContent = "Analyse...";
    $('ocrStatus').classList.remove('hidden');
    
    const r = await fetch('/api/ged/upload', { method: 'POST', body: fd });
    const res = await r.json();
    
    $('ocrStatus').classList.add('success');
    $('ocrStatus').textContent = "Analyse termin√©e !";
    $('dateDoc').value = res.extraction.date_document;
    $('ttc').value = res.extraction.montant_ttc;
    $('raison').value = res.extraction.raison_sociale;
    window.gedId = res.gedId;
  };

  window.onload = async () => {
    const r = await fetch('/api/admin/public');
    const d = await r.json();
    $('viewDossier').value = d.codeDossier || "Non configur√©";
  };
</script>
</body>
</html>
