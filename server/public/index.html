<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Frais — GED + OCR</title>
  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#f5f6f8;color:#222}
    .container{max-width:900px;margin:40px auto;padding:20px}
    .card{background:#fff;padding:20px;margin-bottom:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    label{display:block;margin-bottom:12px;font-size:14px}
    input,select,textarea{width:100%;padding:8px;margin-top:4px;border-radius:4px;border:1px solid #ccc;font-size:14px}
    textarea{min-height:220px;font-family:monospace}
    .row{display:flex;gap:20px}
    .row>div{flex:1}
    button{padding:10px 16px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold}
    button:hover{background:#0056b3}
    .error{color:#c00;margin-top:10px;font-size:13px;white-space:pre-wrap}
    .success{color:#0a7a2a;margin-top:10px;font-size:13px;white-space:pre-wrap}
    .hidden{display:none}
    .hint{font-size:12px;color:#666;margin-top:-8px;margin-bottom:10px}
  </style>
</head>
<body>
<div class="container">
  <h1 id="pageTitle">Gestion des frais</h1>

  <!-- ADMIN -->
  <div id="adminBlock" class="card hidden">
    <h3>Admin</h3>

    <label>CNX base URL (ex: https://isuiteacd.suiteexpert.fr/cnx/api)
      <input id="baseUrl" placeholder="https://isuiteacd.suiteexpert.fr/cnx/api">
    </label>

    <div class="row">
      <div>
        <label>Identifiant
          <input id="identifiant" placeholder="...">
        </label>
      </div>
      <div>
        <label>Mot de passe
          <input id="motdepasse" type="password" placeholder="...">
        </label>
      </div>
    </div>

    <label>Code dossier (ex: DA_CONSEIL)
      <input id="codeDossier" placeholder="DA_CONSEIL">
    </label>
    <div class="hint">Requis : l’upload GED est bloqué si vide.</div>

    <button id="saveAdmin">Enregistrer</button>
    <button id="openDossier" style="background:#28a745;margin-left:8px">Ouvrir dossier</button>

    <div id="adminErr" class="error"></div>
    <div id="adminOk" class="success"></div>
  </div>

  <!-- USER -->
  <div id="userBlock" class="hidden">
    <p>1) Upload PDF en GED + OCR → 2) Ajuste puis génère le JSON écritures</p>

    <div class="card">
      <h3>1️⃣ Upload PDF en GED + OCR</h3>

      <label>Code dossier (admin)
        <input id="codeDossierView" readonly>
      </label>

      <label>PDF à envoyer
        <input type="file" id="pdfGed" accept="application/pdf">
      </label>

      <button id="uploadGed">Envoyer + OCR</button>

      <div id="gedErr" class="error"></div>
      <div id="gedOk" class="success"></div>

      <label>ID GED (référence)
        <input id="referenceGedId" readonly>
      </label>
    </div>

    <div class="card">
      <h3>2️⃣ Écritures</h3>

      <div class="row">
        <div>
          <label>Journal
            <input id="journal" value="AC">
          </label>
        </div>
        <div>
          <label>Compte fournisseur (F...)
            <select id="compteFournisseur">
              <option value="FREPAS">FREPAS</option>
              <option value="FCARBU">FCARBU</option>
              <option value="FPARKING">FPARKING</option>
              <option value="FPEAGE">FPEAGE</option>
              <option value="FDIVERS" selected>FDIVERS</option>
            </select>
          </label>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Catégorie (HT)
            <select id="categorie"></select>
          </label>
        </div>
        <div>
          <label>TVA (%)
            <select id="tvaRate"></select>
          </label>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Date ticket (YYYY-MM-DD)
            <input id="dateTicket" placeholder="2025-01-02">
          </label>
        </div>
        <div>
          <label>Numéro ticket
            <input id="numeroTicket" placeholder="ex: 000123">
          </label>
        </div>
      </div>

      <label>Raison sociale (libellé)
        <input id="raisonSociale" placeholder="ex: L'ATELIER DE LA PAIX">
      </label>

      <div class="row">
        <div>
          <label>Montant TTC
            <input id="ttc" inputmode="decimal" placeholder="25,50">
          </label>
        </div>
        <div>
          <label>Montant HT
            <input id="ht" inputmode="decimal" placeholder="23,18">
          </label>
        </div>
      </div>

      <label>Montant TVA
        <input id="tvaMontant" inputmode="decimal" placeholder="2,32">
      </label>

      <button id="submit">Générer JSON</button>
      <div id="err" class="error"></div>
    </div>

    <div class="card">
      <h3>Résultat JSON</h3>
      <textarea id="result" readonly></textarea>
    </div>
  </div>
</div>

<script>
  const el = id => document.getElementById(id);
  const qs = new URLSearchParams(location.search);
  const isAdmin = qs.get("admin") === "1";

  const CATEGORIES = [
    { key: "petites_fournitures", label: "Petites fournitures et entretien", vat: ["20","10"] },
    { key: "papeterie", label: "Papeterie", vat: ["20"] },
    { key: "carburant", label: "Carburant", vat: ["20"] },
    { key: "repas_pro", label: "Repas pro", vat: ["10"] },
    { key: "repas", label: "Repas (TVA 0%)", vat: ["0"] },
    { key: "peages", label: "Péages", vat: ["20"] },
    { key: "parking", label: "Parking", vat: ["20"] }
  ];

  function toNumOrNull(v){
    const s = String(v || "").trim().replace(",", ".");
    if (!s) return null;
    const x = Number(s);
    return Number.isFinite(x) ? x : null;
  }

  function setSelect(selectEl, value){
    if (!value) return;
    const opt = [...selectEl.options].find(o => o.value === value);
    if (opt) selectEl.value = value;
  }

  function fillCategories(){
    el("categorie").innerHTML = CATEGORIES.map(c => `<option value="${c.key}">${c.label}</option>`).join("");
  }

  function fillVatForCurrentCategory(){
    const cat = CATEGORIES.find(c => c.key === el("categorie").value);
    const allowed = cat ? cat.vat : ["20","10","0"];
    const current = el("tvaRate").value;

    el("tvaRate").innerHTML = allowed.map(v => `<option value="${v}">${v}%</option>`).join("");
    if (allowed.includes(current)) el("tvaRate").value = current;
  }

  async function loadCodeDossier(){
    try{
      const resp = await fetch("/api/admin/public");
      const out = await resp.json();
      el("codeDossierView").value = out.codeDossier || "";
      return out.codeDossier || "";
    }catch{
      el("codeDossierView").value = "";
      return "";
    }
  }

  if (isAdmin){
    el("pageTitle").textContent = "Admin";
    el("adminBlock").classList.remove("hidden");

    el("saveAdmin").addEventListener("click", async () => {
      el("adminErr").textContent = "";
      el("adminOk").textContent = "";

      const payload = {
        baseUrl: el("baseUrl").value.trim(),
        identifiant: el("identifiant").value.trim(),
        motdepasse: el("motdepasse").value,
        codeDossier: el("codeDossier").value.trim()
      };

      try{
        const resp = await fetch("/api/admin/config", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const out = await resp.json();
        if (!resp.ok) throw new Error(out.error || "Erreur");
        el("adminOk").textContent = "OK — enregistré.";
      }catch(e){
        el("adminErr").textContent = String(e.message || e);
      }
    });

    el("openDossier").addEventListener("click", async () => {
      el("adminErr").textContent = "";
      el("adminOk").textContent = "";

      const codeDossier = el("codeDossier").value.trim();
      if (!codeDossier){
        el("adminErr").textContent = "Code dossier obligatoire (ex: DA_CONSEIL).";
        return;
      }

      try{
        const resp = await fetch("/api/cnx/session-dossier", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ codeDossier })
        });
        const out = await resp.json();
        if (!resp.ok) throw new Error(out.error || "Erreur");
        el("adminOk").textContent = "OK — dossier ouvert (réponse reçue).";
      }catch(e){
        el("adminErr").textContent = String(e.message || e);
      }
    });

  } else {
    el("userBlock").classList.remove("hidden");
    fillCategories();
    fillVatForCurrentCategory();

    el("categorie").addEventListener("change", () => fillVatForCurrentCategory());

    // Charger le code dossier et bloquer si vide
    let currentCodeDossier = "";
    (async () => {
      currentCodeDossier = await loadCodeDossier();
      if (!currentCodeDossier){
        el("gedErr").textContent = "Code dossier non configuré. Va sur /?admin=1 et renseigne-le.";
      }
    })();

    el("uploadGed").addEventListener("click", async () => {
      el("gedErr").textContent = "";
      el("gedOk").textContent = "";

      // ✅ blocage si code dossier vide
      const codeDossier = (el("codeDossierView").value || "").trim();
      if (!codeDossier){
        el("gedErr").textContent = "Upload bloqué : code dossier manquant. Va sur /?admin=1 et renseigne-le.";
        return;
      }

      const file = el("pdfGed").files[0];
      if (!file) { el("gedErr").textContent = "Choisis un PDF."; return; }

      const form = new FormData();
      form.append("pdf", file, file.name || "ticket.pdf");

      try {
        const resp = await fetch("/api/ged/upload", { method: "POST", body: form });
        const out = await resp.json();
        if (!resp.ok) throw new Error(out.error || "Erreur upload/OCR");

        el("referenceGedId").value = out.gedId;
        el("gedOk").textContent = "OK — Upload GED + OCR terminé. Id GED = " + out.gedId;

        const ex = out.extraction || {};
        if (ex.date_document) el("dateTicket").value = ex.date_document;
        if (ex.numero_ticket) el("numeroTicket").value = ex.numero_ticket;
        if (ex.raison_sociale) el("raisonSociale").value = ex.raison_sociale;

        if (typeof ex.montant_ttc === "number") el("ttc").value = String(ex.montant_ttc).replace(".", ",");
        if (typeof ex.montant_ht === "number") el("ht").value = String(ex.montant_ht).replace(".", ",");
        if (typeof ex.montant_tva === "number") el("tvaMontant").value = String(ex.montant_tva).replace(".", ",");

        // ✅ Mapping auto (catégorie / TVA / compte F)
        const sug = out.suggestion || {};
        if (sug.categorie_ui) setSelect(el("categorie"), sug.categorie_ui);

        fillVatForCurrentCategory();
        setSelect(el("tvaRate"), sug.tva_rate);

        setSelect(el("compteFournisseur"), sug.compteF);

      } catch (e) {
        el("gedErr").textContent = String(e.message || e);
      }
    });

    el("submit").addEventListener("click", async () => {
      el("err").textContent = "";
      el("result").value = "";

      const referenceGedId = el("referenceGedId").value.trim();
      if (!referenceGedId) { el("err").textContent = "Uploade d'abord le PDF (Id GED requis)."; return; }

      const meta = {
        journal: el("journal").value.trim(),
        compteFournisseur: el("compteFournisseur").value,
        referenceGedId,
        categorie_ui: el("categorie").value,
        tva_rate: el("tvaRate").value,
        date_ticket: el("dateTicket").value.trim(),
        numero_ticket: el("numeroTicket").value.trim(),
        raison_sociale: el("raisonSociale").value.trim(),
        montant_ttc: toNumOrNull(el("ttc").value),
        ht: toNumOrNull(el("ht").value),
        tva_montant: toNumOrNull(el("tvaMontant").value)
      };

      const form = new FormData();
      form.append("meta", JSON.stringify(meta));

      try {
        const resp = await fetch("/api/receipts/process", { method:"POST", body: form });
        const out = await resp.json();
        if (!resp.ok) throw new Error(out.error || "Erreur génération JSON");
        el("result").value = JSON.stringify(out, null, 2);
      } catch (e) {
        el("err").textContent = String(e.message || e);
      }
    });
  }
</script>
</body>
</html>
