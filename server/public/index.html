<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tikeo - Gestion des frais</title>

  <style>
    :root{
      --primary:#2563eb;
      --primary-hover:#1d4ed8;
      --success:#059669;
      --error:#dc2626;
      --bg:#f8fafc;
      --card-bg:#ffffff;
      --text-main:#0f172a;
      --text-muted:#64748b;
      --border:#e2e8f0;
      --radius:14px;
      --shadow:0 10px 22px rgba(15, 23, 42, .08);
      --shadow-soft:0 4px 10px rgba(15, 23, 42, .06);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Segoe UI", system-ui, -apple-system, sans-serif;
      background:var(--bg);
      color:var(--text-main);
      line-height:1.5;
    }

    .container{
      max-width:760px;
      margin:0 auto;
      padding:20px;
      padding-bottom:80px;
    }

    center img{
      max-width:140px;
      margin:10px auto 6px;
      filter:drop-shadow(0 8px 12px rgba(15,23,42,.10));
    }

    h1{
      font-size:1.55rem;
      font-weight:900;
      text-align:center;
      margin:8px 0 22px;
      letter-spacing:-.02em;
    }

    .card{
      background:var(--card-bg);
      padding:22px;
      margin-bottom:18px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow-soft);
    }

    .card h3{
      margin:0 0 14px;
      font-size:1.05rem;
      font-weight:800;
      letter-spacing:-.01em;
    }

    label{
      display:block;
      margin-bottom:14px;
      font-size:.9rem;
      font-weight:700;
      color:var(--text-main);
    }

    .hint{
      font-size:.82rem;
      color:var(--text-muted);
      margin-top:-8px;
      margin-bottom:12px;
    }

    input, select, textarea{
      width:100%;
      margin-top:6px;
      padding:12px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:16px;
      background:#fcfcfd;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, transform .05s ease;
    }

    input:focus, select:focus, textarea:focus{
      border-color:rgba(37,99,235,.55);
      box-shadow:0 0 0 4px rgba(37,99,235,.14);
    }

    input[readonly]{
      background:#f1f5f9;
      color:#0f172a;
    }

    textarea{
      min-height:180px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
    }
    .row > div{
      flex:1;
      min-width:170px;
    }

    button{
      width:100%;
      padding:14px 16px;
      margin-top:10px;
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      font-size:.98rem;
      box-shadow:var(--shadow);
      transition:transform .06s ease, background .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    button:hover{ background:var(--primary-hover); }
    button:active{ transform:translateY(1px); box-shadow:var(--shadow-soft); }

    #openDossier{ background:var(--success) !important; }
    #openDossier:hover{ filter:brightness(.95); }

    .error, .success{
      padding:12px;
      border-radius:12px;
      margin-top:14px;
      font-size:.88rem;
      font-weight:650;
      white-space:pre-wrap;
      border:1px solid transparent;
    }
    .error{ background:#fee2e2; color:var(--error); border-color:#fecaca; }
    .success{ background:#ecfdf5; color:var(--success); border-color:#d1fae5; }
    .error:empty, .success:empty, .hidden{ display:none; }

    .file-wrap{ margin-top:8px; }
    .file-drop{
      display:block;
      width:100%;
      border:1.5px dashed #cbd5e1;
      border-radius:14px;
      padding:14px;
      background:linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
      box-shadow:0 1px 0 rgba(15,23,42,.03);
      cursor:pointer;
      transition:border-color .15s ease, box-shadow .15s ease, transform .05s ease;
      user-select:none;
    }
    .file-drop:hover{
      border-color:rgba(37,99,235,.55);
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }
    .file-drop strong{ display:block; font-weight:850; margin-bottom:4px; }
    .file-drop span{ color:var(--text-muted); font-size:.86rem; }
    input[type="file"]{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
      opacity:0;
    }

    button[disabled]{
      opacity:.7;
      cursor:not-allowed;
      filter:saturate(.9);
    }

    .title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .title-row h3{ margin:0; }

    .icon-btn{
      width:40px;
      height:40px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:var(--shadow-soft);
      padding:0;
      color:#000;
    }
    .icon-btn:hover{
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
      border-color:rgba(37,99,235,.55);
      color:#000;
    }
    .icon-btn svg{ width:20px; height:20px; }

    @media (max-width:520px){
      .container{ padding:14px; }
      .card{ padding:18px; }
      .row > div{ min-width:100%; }
      h1{ font-size:1.35rem; }
      #debugCard{ display:none !important; }
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220;
        --card-bg:#0f172a;
        --text-main:#e5e7eb;
        --text-muted:#94a3b8;
        --border:#1f2a44;
        --shadow:0 10px 22px rgba(0,0,0,.35);
        --shadow-soft:0 6px 14px rgba(0,0,0,.28);
      }
      body{ background:var(--bg); color:var(--text-main); }
      input, select, textarea{ background:#0b1326; color:var(--text-main); border-color:var(--border); }
      input[readonly]{ background:#0b1326; }
      .card{ background:var(--card-bg); border-color:var(--border); }
      .file-drop{ background:linear-gradient(180deg, #0f172a 0%, #0b1326 100%); border-color:#334155; }
      .icon-btn{ background:#0f172a; border-color:var(--border); color:#e5e7eb; }
      .error{ background:rgba(220,38,38,.18); border-color:rgba(220,38,38,.35); color:#fecaca; }
      .success{ background:rgba(5,150,105,.18); border-color:rgba(5,150,105,.35); color:#a7f3d0; }
    }
  </style>
</head>

<body>
<div class="container">
  <center><img src="http://www.image-heberg.fr/files/1772025987602134325.png" alt="Tikeo.png" /></center>
  <h1 id="pageTitle">Gestion des frais</h1>

  <div id="adminBlock" class="card hidden">
    <h3>Admin</h3>
    <label>CNX base URL (ex: https://isuiteacd.suiteexpert.fr/cnx/api)
      <input id="baseUrl" placeholder="https://isuiteacd.suiteexpert.fr/cnx/api">
    </label>
    <div class="row">
      <div><label>Identifiant<input id="identifiant" placeholder="..."></label></div>
      <div><label>Mot de passe<input id="motdepasse" type="password" placeholder="..."></label></div>
    </div>
    <label>Code dossier (ex: DA_CONSEIL)<input id="codeDossier" placeholder="Code dossier Comptabilité"></label>
    <div class="hint">Requis : l’upload GED est bloqué si vide.</div>
    <button id="saveAdmin">Enregistrer</button>
    <button id="openDossier" style="background:#28a745;margin-left:8px">Ouvrir dossier</button>
    <button id="backHome" style="background:#64748b">Retour accueil</button>
    <button id="resetTicketCounter" style="background:#ef4444">RAZ compteur tickets</button>
    <div id="adminErr" class="error"></div>
    <div id="adminOk" class="success"></div>
  </div>

  <div id="userBlock" class="hidden">
    <div class="card">
      <div class="title-row">
        <h3>1️⃣ Scannez le ticket ou importez le PDF</h3>
        <button class="icon-btn" id="goAdmin" type="button" aria-label="Réglages">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
            <path d="M19.4 15a7.9 7.9 0 0 0 .1-2l2-1.2-2-3.4-2.3.6a8 8 0 0 0-1.7-1l-.3-2.4H10.8L10.5 7a8 8 0 0 0-1.7 1L6.5 7.4l-2 3.4 2 1.2a7.9 7.9 0 0 0 .1 2l-2 1.2 2 3.4 2.3-.6a8 8 0 0 0 1.7 1l.3 2.4h4.4l.3-2.4a8 8 0 0 0 1.7-1l2.3.6 2-3.4-2-1.2z"/>
          </svg>
        </button>
      </div>
      <label>Code dossier comptable<input id="codeDossierView" readonly></label>
      <div class="file-wrap">
        <label class="file-drop" for="fileInput">
          <strong>Choisir un PDF ou prendre une photo</strong>
          <span>L'IA analyse le ticket automatiquement.</span>
        </label>
        <input type="file" id="fileInput" accept="application/pdf,image/*" capture="environment">
      </div>
      <button id="uploadGed">Envoyer le ticket</button>
      <div id="gedErr" class="error"></div>
      <div id="gedOk" class="success"></div>
      <input id="referenceGedId" type="hidden">
    </div>

    <div class="card">
      <h3>2️⃣ Écriture comptable</h3>
      <div class="row">
        <div><label>Journal<input id="journal" value="AC"></label></div>
        <div>
          <label>Fournisseur
            <select id="compteFournisseur">
              <option value="FREPAS">FREPAS</option>
              <option value="FCARBU">FCARBU</option>
              <option value="FPARKING">FPARKING</option>
              <option value="FPEAGE">FPEAGE</option>
              <option value="FDIVERS" selected>FDIVERS</option>
            </select>
          </label>
        </div>
      </div>
      <div class="row">
        <div><label>Catégorie dépenses<select id="categorie"></select></label></div>
        <div><label>TVA (%)<select id="tvaRate"></select></label></div>
      </div>
      <div class="row">
        <div><label>Date ticket (YYYY-MM-DD)<input id="dateTicket" placeholder="2025-01-02"></label></div>
        <div><label>Numéro ticket<input id="numeroTicket" placeholder="(auto)"></label></div>
      </div>
      <label>Raison sociale (libellé)<input id="raisonSociale" placeholder="ex: L'ATELIER DE LA PAIX"></label>
      <div class="row">
        <div><label>Montant TTC<input id="ttc" inputmode="decimal" placeholder="25,50"></label></div>
        <div><label>Montant HT<input id="ht" inputmode="decimal" placeholder="23,18"></label></div>
      </div>
      <label>Montant TVA<input id="tvaMontant" inputmode="decimal" placeholder="2,32"></label>
      <button id="submit">Envoyer l’écriture</button>
      <div id="err" class="error"></div>
      <div id="ok" class="success"></div>
    </div>

    <div id="debugCard" class="card hidden">
      <h3>Debug (/?debug=1)</h3>
      <textarea id="debugOut" readonly></textarea>
    </div>
  </div>
</div>

<script>
  const el = (id) => document.getElementById(id);
  const qs = new URLSearchParams(location.search);
  const isAdmin = qs.get("admin") === "1";
  const isDebug = qs.get("debug") === "1";

  const CATEGORIES = [
    { key: "petites_fournitures", label: "Petites fournitures et entretien", vat: ["20","10"] },
    { key: "papeterie", label: "Papeterie", vat: ["20"] },
    { key: "carburant", label: "Carburant", vat: ["20"] },
    { key: "repas_pro", label: "Repas pro", vat: ["10"] },
    { key: "repas", label: "Repas (TVA 0%)", vat: ["0"] },
    { key: "peages", label: "Péages", vat: ["20"] },
    { key: "parking", label: "Parking", vat: ["20"] }
  ];

  /* --- Fonctions Utilitaires --- */
  function toNumOrNull(v){
    const s = String(v || "").trim().replace(",", ".");
    if (!s) return null;
    const x = Number(s);
    return Number.isFinite(x) ? x : null;
  }

  function setSelect(selectEl, value){
    if (!value) return;
    const opt = [...selectEl.options].find(o => o.value === value);
    if (opt) selectEl.value = value;
  }

  function fillCategories(){
    el("categorie").innerHTML = CATEGORIES.map(c => `<option value="${c.key}">${c.label}</option>`).join("");
  }

  function fillVatForCurrentCategory(){
    const cat = CATEGORIES.find(c => c.key === el("categorie").value);
    const allowed = cat ? cat.vat : ["20","10","0"];
    const current = el("tvaRate").value;
    el("tvaRate").innerHTML = allowed.map(v => `<option value="${v}">${v}%</option>`).join("");
    if (allowed.includes(current)) el("tvaRate").value = current;
  }

  async function loadCodeDossier(){
    try{
      const resp = await fetch("/api/admin/public");
      const out = await resp.json();
      el("codeDossierView").value = out.codeDossier || "";
      return out.codeDossier || "";
    }catch{
      el("codeDossierView").value = "";
      return "";
    }
  }

  function setBtnLoading(btn, isLoading, textLoading) {
    if (!btn) return;
    if (isLoading) {
      btn.dataset._txt = btn.textContent;
      btn.textContent = textLoading || "Traitement...";
      btn.disabled = true;
    } else {
      btn.textContent = btn.dataset._txt || btn.textContent;
      btn.disabled = false;
      delete btn.dataset._txt;
    }
  }

  function getTicketCounter() {
    const v = Number(localStorage.getItem("ticket_counter_T") || "0");
    return Number.isFinite(v) && v >= 0 ? v : 0;
  }

  function peekNextTicketNumber() {
    return "T" + String(getTicketCounter() + 1).padStart(4, "0");
  }

  function commitTicketNumberUsed(num) {
    const m = /^T(\d{4,})$/i.exec(String(num || "").trim());
    if (m) localStorage.setItem("ticket_counter_T", String(Number(m[1])));
  }

  function scheduleRefreshIn5s() {
    setTimeout(() => location.reload(), 5000);
  }

  /* --- Nouvelle logique de préparation Image (Sans OpenCV) --- */
  async function prepareImage(file) {
    if (file.type === "application/pdf") return file;

    const img = await createImageBitmap(file);
    const canvas = document.createElement("canvas");
    const MAX_SIZE = 2000;
    let w = img.width, h = img.height;

    if (w > h && w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; }
    else if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; }

    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, w, h);

    return new Promise(resolve => canvas.toBlob(resolve, "image/jpeg", 0.90));
  }

  /* --- Initialisation --- */
  if (isAdmin) {
    el("pageTitle").textContent = "Admin";
    el("adminBlock").classList.remove("hidden");
    el("backHome").onclick = () => window.location.href = "/?";
    el("resetTicketCounter").onclick = () => {
        if(confirm("Remettre à zéro ?")) localStorage.setItem("ticket_counter_T", "0");
    };
    
    el("saveAdmin").onclick = async () => {
      const payload = {
        baseUrl: el("baseUrl").value.trim(),
        identifiant: el("identifiant").value.trim(),
        motdepasse: el("motdepasse").value,
        codeDossier: el("codeDossier").value.trim()
      };
      setBtnLoading(el("saveAdmin"), true);
      try {
        const r = await fetch("/api/admin/config", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload)});
        if(r.ok) el("adminOk").textContent = "Enregistré.";
      } catch(e) { el("adminErr").textContent = e.message; }
      finally { setBtnLoading(el("saveAdmin"), false); }
    };
  } else {
    el("userBlock").classList.remove("hidden");
    if (isDebug) el("debugCard").classList.remove("hidden");
    el("goAdmin").onclick = () => window.location.href = "/?admin=1";

    fillCategories();
    fillVatForCurrentCategory();
    el("categorie").onchange = fillVatForCurrentCategory;
    loadCodeDossier();

    el("uploadGed").onclick = async () => {
      el("gedErr").textContent = el("gedOk").textContent = "";
      const file = el("fileInput").files[0];
      if (!file) return alert("Sélectionnez un fichier");

      setBtnLoading(el("uploadGed"), true, "Analyse IA...");
      try {
        const processedFile = await prepareImage(file);
        const formData = new FormData();
        formData.append("file", processedFile, processedFile.name || "ticket.jpg");

        const response = await fetch("/api/ged/upload", { method: "POST", body: formData });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Erreur serveur");

        el("referenceGedId").value = data.gedId;
        const ex = data.extraction || {};
        el("dateTicket").value = ex.date_document || "";
        el("raisonSociale").value = ex.raison_sociale || "";
        el("numeroTicket").value = ex.numero_ticket || "";
        if (ex.montant_ttc) el("ttc").value = String(ex.montant_ttc).replace(".", ",");
        if (ex.montant_ht) el("ht").value = String(ex.montant_ht).replace(".", ",");
        if (ex.montant_tva) el("tvaMontant").value = String(ex.montant_tva).replace(".", ",");

        if (data.suggestion?.categorie_ui) setSelect(el("categorie"), data.suggestion.categorie_ui);
        fillVatForCurrentCategory();

        el("gedOk").textContent = "Analyse IA terminée.";
        if (isDebug) el("debugOut").value = JSON.stringify(data, null, 2);
      } catch (e) {
        el("gedErr").textContent = e.message;
      } finally {
        setBtnLoading(el("uploadGed"), false);
      }
    };

    el("submit").onclick = async () => {
      el("err").textContent = el("ok").textContent = "";
      const gedId = el("referenceGedId").value;
      if (!gedId) return alert("Scannez d'abord le ticket.");

      const existingNum = el("numeroTicket").value.trim();
      const numToUse = existingNum || peekNextTicketNumber();
      if (!existingNum) el("numeroTicket").value = numToUse;

      const meta = {
        journal: el("journal").value,
        compteFournisseur: el("compteFournisseur").value,
        referenceGedId: gedId,
        categorie_ui: el("categorie").value,
        tva_rate: el("tvaRate").value,
        date_ticket: el("dateTicket").value,
        numero_ticket: numToUse,
        raison_sociale: el("raisonSociale").value,
        montant_ttc: toNumOrNull(el("ttc").value),
        ht: toNumOrNull(el("ht").value),
        tva_montant: toNumOrNull(el("tvaMontant").value)
      };

      setBtnLoading(el("submit"), true, "Envoi...");
      try {
        const f = new FormData(); f.append("meta", JSON.stringify(meta));
        const r = await fetch("/api/receipts/submit", { method: "POST", body: f });
        if (!r.ok) throw new Error("Erreur envoi");
        if (!existingNum) commitTicketNumberUsed(numToUse);
        el("ok").textContent = "✅ Écriture envoyée.";
        scheduleRefreshIn5s();
      } catch (e) {
        el("err").textContent = "❌ " + e.message;
      } finally {
        setBtnLoading(el("submit"), false);
      }
    };
  }
</script>
</body>
</html>
