<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tikeo</title>
  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#f5f6f8;color:#222}
    .container{max-width:980px;margin:40px auto;padding:20px}
    .card{background:#fff;padding:20px;margin-bottom:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    label{display:block;margin-bottom:12px;font-size:14px}
    input,select,textarea{width:100%;padding:8px;margin-top:4px;border-radius:4px;border:1px solid #ccc;font-size:14px}
    textarea{min-height:180px;font-family:monospace}
    .row{display:flex;gap:20px}
    .row>div{flex:1}
    button{padding:10px 16px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold}
    button:hover{background:#0056b3}
    button.secondary{background:#6c757d}
    button.secondary:hover{background:#545b62}
    button.ok{background:#28a745}
    button.ok:hover{background:#1e7e34}
    .error{color:#c00;margin-top:10px;font-size:13px;white-space:pre-wrap}
    .success{color:#0a7a2a;margin-top:10px;font-size:13px;white-space:pre-wrap}
    .hidden{display:none}
    .hint{font-size:12px;color:#666;margin-top:-8px;margin-bottom:10px}
    .previewWrap{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
    .previewBox{border:1px solid #ddd;border-radius:8px;padding:10px;background:#fafafa}
    canvas{max-width:420px;width:100%;height:auto;border-radius:6px;background:#fff}
    video{max-width:420px;width:100%;border-radius:8px;background:#000}
    .small{font-size:12px;color:#555}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eee;font-size:12px}
  </style>
</head>
<body>
<div class="container">
  <h1 id="pageTitle">Tikeo - Gestion des frais</h1>

  <!-- ADMIN -->
  <div id="adminBlock" class="card hidden">
    <h3>Admin</h3>

    <label>CNX base URL (ex: https://isuiteacd.suiteexpert.fr/cnx/api)
      <input id="baseUrl" placeholder="https://isuiteacd.suiteexpert.fr/cnx/api">
    </label>

    <div class="row">
      <div>
        <label>Identifiant
          <input id="identifiant" placeholder="...">
        </label>
      </div>
      <div>
        <label>Mot de passe
          <input id="motdepasse" type="password" placeholder="...">
        </label>
      </div>
    </div>

    <label>Code dossier (ex: DA_CONSEIL)
      <input id="codeDossier" placeholder="DA_CONSEIL">
    </label>
    <div class="hint">Requis : l’upload GED est bloqué si vide.</div>

    <div class="btnRow">
      <button id="saveAdmin">Enregistrer</button>
      <button id="openDossier" class="ok">Ouvrir dossier</button>
    </div>

    <div id="adminErr" class="error"></div>
    <div id="adminOk" class="success"></div>
  </div>

  <!-- USER -->
  <div id="userBlock" class="hidden">
    <p>Choisis un PDF, ou scanne en live avec auto-capture (10 fps). Ensuite GED + OCR puis envoi écriture.</p>

    <div class="card">
      <h3>1️⃣ Scannez ou choisir le ticket</h3>

      <label>Code dossier (admin)
        <input id="codeDossierView" readonly>
      </label>

      <div class="row">
        <div>
          <label>Importer un PDF (déjà scanné)
            <input type="file" id="fileInput" accept="application/pdf">
          </label>
        </div>
        <div>
          <label>Scanner le document.
            <div class="btnRow">
              <button id="startCam">Démarrer le scan</button>
              <button id="stopCam" class="secondary" disabled>Stop</button>
            </div>
          </label>
        </div>
      </div>

      <!-- LIVE CAMERA + OVERLAY -->
      <div id="camPanel" class="previewWrap hidden">
        <div class="previewBox">
          <div class="small">
            <b>Caméra</b>
            <span id="camPill" class="pill">init…</span>
          </div>
          <video id="cam" playsinline muted></video>
          <canvas id="frame" class="hidden"></canvas>
        </div>

        <div class="previewBox">
          <div class="small"><b>Détection ticket</b></div>
          <canvas id="overlay"></canvas>
          <div id="camStatus" class="small"></div>
          <div id="camErr" class="error"></div>
        </div>
      </div>

      <!-- PREVIEW (scanned result) -->
      <div id="scanPanel" class="previewWrap hidden">
        <div class="previewBox">
          <div class="small"><b>Aperçu ticket</b></div>
          <canvas id="scanCanvas"></canvas>
          <div class="small" id="scanMeta"></div>
        </div>

        <div class="previewBox" style="min-width:260px">
          <div class="btnRow" style="margin-top:10px">
            <button id="clearScanBtn" class="secondary">Annuler</button>
            <button id="uploadGed" class="ok">Envoyer le ticket </button>
          </div>
          <div class="hint" style="margin-top:10px">
            Auto-capture : aperçu
          </div>
          <div id="scanErr" class="error"></div>
          <div id="scanOk" class="success"></div>
        </div>
      </div>

      <div id="gedErr" class="error"></div>
      <div id="gedOk" class="success"></div>

      <label>Référence doument dans la GED (à titre d'information)
        <input id="referenceGedId" readonly>
      </label>
    </div>

    <div class="card">
      <h3>2️⃣ Publication des écritures en comptabilité</h3>

      <div class="row">
        <div>
          <label>Journal
            <input id="journal" value="AC">
          </label>
        </div>
        <div>
          <label>Fournisseur
            <select id="compteFournisseur">
              <option value="FREPAS">FREPAS</option>
              <option value="FCARBU">FCARBU</option>
              <option value="FPARKING">FPARKING</option>
              <option value="FPEAGE">FPEAGE</option>
              <option value="FDIVERS" selected>FDIVERS</option>
            </select>
          </label>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Catégorie charges
            <select id="categorie"></select>
          </label>
        </div>
        <div>
          <label>TVA (%)
            <select id="tvaRate"></select>
          </label>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Date ticket (YYYY-MM-DD)
            <input id="dateTicket" placeholder="2025-01-02">
          </label>
        </div>
        <div>
          <label>Numéro ticket (si vide → auto T0001, T0002…)
            <input id="numeroTicket" placeholder="ex: T0001">
          </label>
        </div>
      </div>

      <label>Raison sociale
        <input id="raisonSociale" placeholder="ex: L'ATELIER DE LA PAIX">
      </label>

      <div class="row">
        <div>
          <label>Montant TTC
            <input id="ttc" inputmode="decimal" placeholder="25,50">
          </label>
        </div>
        <div>
          <label>Montant HT
            <input id="ht" inputmode="decimal" placeholder="23,18">
          </label>
        </div>
      </div>

      <label>Montant TVA
        <input id="tvaMontant" inputmode="decimal" placeholder="2,32">
      </label>

      <button id="submit" class="ok">Envoyer l’écriture</button>
      <div id="err" class="error"></div>
      <div id="ok" class="success"></div>
    </div>

    <div id="debugCard" class="card hidden">
      <h3>Debug (/?debug=1)</h3>
      <textarea id="debugOut" readonly></textarea>
    </div>
  </div>
</div>

<!-- OpenCV.js -->
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<!-- jscanify (UMD) -->
<script defer src="https://unpkg.com/jscanify@1.2.2/dist/jscanify.min.js"></script>

<script>
  const el = (id) => document.getElementById(id);
  const qs = new URLSearchParams(location.search);
  const isAdmin = qs.get("admin") === "1";
  const isDebug = qs.get("debug") === "1";

  const CATEGORIES = [
    { key: "petites_fournitures", label: "Petites fournitures et entretien", vat: ["20","10"] },
    { key: "papeterie", label: "Papeterie", vat: ["20"] },
    { key: "carburant", label: "Carburant", vat: ["20"] },
    { key: "repas_pro", label: "Repas pro", vat: ["10"] },
    { key: "repas", label: "Repas (TVA 0%)", vat: ["0"] },
    { key: "peages", label: "Péages", vat: ["20"] },
    { key: "parking", label: "Parking", vat: ["20"] }
  ];

  function toNumOrNull(v){
    const s = String(v || "").trim().replace(",", ".");
    if (!s) return null;
    const x = Number(s);
    return Number.isFinite(x) ? x : null;
  }

  function setSelect(selectEl, value){
    if (!value) return;
    const opt = [...selectEl.options].find(o => o.value === value);
    if (opt) selectEl.value = value;
  }

  function fillCategories(){
    el("categorie").innerHTML = CATEGORIES.map(c => `<option value="${c.key}">${c.label}</option>`).join("");
  }

  function fillVatForCurrentCategory(){
    const cat = CATEGORIES.find(c => c.key === el("categorie").value);
    const allowed = cat ? cat.vat : ["20","10","0"];
    const current = el("tvaRate").value;
    el("tvaRate").innerHTML = allowed.map(v => `<option value="${v}">${v}%</option>`).join("");
    if (allowed.includes(current)) el("tvaRate").value = current;
  }

  async function loadCodeDossier(){
    try{
      const resp = await fetch("/api/admin/public");
      const out = await resp.json();
      el("codeDossierView").value = out.codeDossier || "";
      return out.codeDossier || "";
    }catch{
      el("codeDossierView").value = "";
      return "";
    }
  }

  /** ===== Ticket auto: T0001, T0002... ===== */
  function nextTicketNumber() {
    const key = "ticket_counter_T";
    const prev = Number(localStorage.getItem(key) || "0");
    const next = prev + 1;
    localStorage.setItem(key, String(next));
    return "T" + String(next).padStart(4, "0");
  }
  function ensureTicketNumber() {
    const v = String(el("numeroTicket").value || "").trim();
    if (v) return v;
    const t = nextTicketNumber();
    el("numeroTicket").value = t;
    return t;
  }

  /** ===== OpenCV ready ===== */
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  async function waitForOpenCV(timeoutMs=15000){
    const t0 = Date.now();
    while(!(window.cv && cv.Mat)){
      if(Date.now()-t0>timeoutMs) throw new Error("OpenCV.js non chargé (réseau ?)");
      await sleep(60);
    }
  }
  async function waitForJscanify(timeoutMs=15000){
    const t0 = Date.now();
    while(!(window.jscanify)){
      if(Date.now()-t0>timeoutMs) throw new Error("jscanify non chargé (réseau ?)");
      await sleep(60);
    }
  }

  /** ===== PDF from canvas (minimal) ===== */
  function canvasToJpegBytes(canvas, quality = 0.86) {
    const dataUrl = canvas.toDataURL("image/jpeg", quality);
    const base64 = dataUrl.split(",")[1];
    const bin = atob(base64);
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    return { bytes, w: canvas.width, h: canvas.height };
  }
  function strToBytes(s) { return new TextEncoder().encode(s); }

  function jpegToPdfBlob(jpegBytes, imgW, imgH) {
    const pageW = 595, pageH = 842;
    const margin = 24;
    const boxW = pageW - 2*margin;
    const boxH = pageH - 2*margin;

    const imgRatio = imgW / imgH;
    let drawW = boxW;
    let drawH = Math.round(drawW / imgRatio);
    if (drawH > boxH) { drawH = boxH; drawW = Math.round(drawH * imgRatio); }
    const x = Math.round((pageW - drawW) / 2);
    const y = Math.round((pageH - drawH) / 2);

    const chunks = [];
    const objOffsets = [0];
    let cursor = 0;

    function addChunk(s) { const b = strToBytes(s); chunks.push(b); cursor += b.length; }
    function addBin(u8) { chunks.push(u8); cursor += u8.length; }
    function markObj() { objOffsets.push(cursor); }

    addChunk("%PDF-1.4\n%âãÏÓ\n");
    markObj(); addChunk("1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n");
    markObj(); addChunk("2 0 obj\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\nendobj\n");
    markObj(); addChunk(
      `3 0 obj\n<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${pageW} ${pageH}] ` +
      `/Resources << /XObject << /Im0 4 0 R >> >> /Contents 5 0 R >>\nendobj\n`
    );

    markObj();
    addChunk(
      `4 0 obj\n<< /Type /XObject /Subtype /Image /Name /Im0 /Width ${imgW} /Height ${imgH} ` +
      `/ColorSpace /DeviceRGB /BitsPerComponent 8 /Filter /DCTDecode /Length ${jpegBytes.length} >>\nstream\n`
    );
    addBin(jpegBytes);
    addChunk("\nendstream\nendobj\n");

    const content = `q\n${drawW} 0 0 ${drawH} ${x} ${y} cm\n/Im0 Do\nQ\n`;
    const contentBytes = strToBytes(content);

    markObj();
    addChunk(`5 0 obj\n<< /Length ${contentBytes.length} >>\nstream\n`);
    addBin(contentBytes);
    addChunk("\nendstream\nendobj\n");

    const xrefPos = cursor;
    addChunk("xref\n0 6\n0000000000 65535 f \n");
    for (let i = 1; i <= 5; i++) addChunk(String(objOffsets[i]).padStart(10, "0") + " 00000 n \n");
    addChunk(`trailer\n<< /Size 6 /Root 1 0 R >>\nstartxref\n${xrefPos}\n%%EOF\n`);

    return new Blob(chunks, { type: "application/pdf" });
  }

  function canvasToPdfBlob(canvas) {
    const { bytes, w, h } = canvasToJpegBytes(canvas, 0.86);
    return jpegToPdfBlob(bytes, w, h);
  }

  /** ===== State upload ===== */
  let pendingPdfBlob = null;
  let pendingPdfFilename = "ticket.pdf";

  function showPreviewCanvas(canvas) {
    const dst = el("scanCanvas");
    dst.width = canvas.width;
    dst.height = canvas.height;
    dst.getContext("2d").drawImage(canvas, 0, 0);
  }

  function resetAll() {
    pendingPdfBlob = null;
    pendingPdfFilename = "ticket.pdf";
    el("fileInput").value = "";
    el("referenceGedId").value = "";
    el("gedErr").textContent = "";
    el("gedOk").textContent = "";
    el("scanErr").textContent = "";
    el("scanOk").textContent = "";
    el("scanMeta").textContent = "";
    el("scanPanel").classList.add("hidden");
    const c = el("scanCanvas"); c.width = 1; c.height = 1;
  }

  /** ===== jscanify live camera (10 fps) + auto capture ===== */
  let scanner = null;
  let camStream = null;
  let loopTimer = null;
  let lastCornerPoints = null;
  let stableCount = 0;
  let autoCaptured = false;

  const TARGET_FPS = 10;               // ✅ 10 fps
  const LOOP_MS = Math.round(1000 / TARGET_FPS);
  const STABLE_FRAMES = 6;             // ~0.6s stable
  const AUTO_CAPTURE_COOLDOWN_MS = 2500;

  async function startCam() {
    el("camErr").textContent = "";
    el("camStatus").textContent = "";
    el("camPanel").classList.remove("hidden");
    el("camPill").textContent = "init…";
    el("stopCam").disabled = false;
    el("startCam").disabled = true;

    try {
      await waitForOpenCV();
      await waitForJscanify();

      scanner = new jscanify();

      const video = el("cam");
      const frame = el("frame");
      const overlay = el("overlay");
      const frameCtx = frame.getContext("2d");
      const overlayCtx = overlay.getContext("2d");

      camStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 },     // ✅ 1280×720
          height: { ideal: 720 }
        },
        audio: false
      });

      video.srcObject = camStream;
      await video.play();

      // Use actual stream dimensions (iOS sometimes differs)
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      frame.width = w; frame.height = h;
      overlay.width = w; overlay.height = h;

      el("camPill").textContent = `${w}×${h} @${TARGET_FPS}fps`;
      el("camStatus").textContent = "Détection… garde les 4 coins visibles.";
      stableCount = 0;
      lastCornerPoints = null;
      autoCaptured = false;

      // main loop ~10 fps
      loopTimer = setInterval(() => {
        try {
          if (!video.videoWidth || !video.videoHeight) return;

          frameCtx.drawImage(video, 0, 0, w, h);

          // highlight overlay
          const highlightedCanvas = scanner.highlightPaper(frame);
          overlayCtx.clearRect(0, 0, w, h);
          overlayCtx.drawImage(highlightedCanvas, 0, 0);

          // get corners (needs Mat)
          const mat = cv.imread(frame);
          const contour = scanner.findPaperContour(mat);
          mat.delete();

          if (contour) {
            const pts = scanner.getCornerPoints(contour);
            contour.delete?.();

            lastCornerPoints = pts;
            stableCount++;
          } else {
            lastCornerPoints = null;
            stableCount = 0;
          }

          const stable = stableCount >= STABLE_FRAMES;

          el("camStatus").textContent = stable
            ? "Ticket détecté ✅ auto-capture…"
            : "Détection… garde les 4 coins visibles.";

          // ✅ auto-capture when stable
          if (stable && !autoCaptured) {
            autoCaptured = true;
            try {
              doAutoCapture(frame, lastCornerPoints);
            } catch (e) {
              el("camErr").textContent = String(e.message || e);
              autoCaptured = false;
            }
            // cooldown to avoid multiple captures
            setTimeout(() => { autoCaptured = false; stableCount = 0; }, AUTO_CAPTURE_COOLDOWN_MS);
          }

        } catch (e) {
          // reset stability if something transient happens
          lastCornerPoints = null;
          stableCount = 0;
        }
      }, LOOP_MS);

    } catch (e) {
      el("camErr").textContent = String(e.message || e);
      stopCam();
      el("startCam").disabled = false;
    }
  }

  function stopCam() {
    if (loopTimer) { clearInterval(loopTimer); loopTimer = null; }
    if (camStream) {
      camStream.getTracks().forEach(t => t.stop());
      camStream = null;
    }
    el("stopCam").disabled = true;
    el("startCam").disabled = false;
    el("camPanel").classList.add("hidden");
    el("camStatus").textContent = "";
    el("camPill").textContent = "off";
    el("camErr").textContent = "";
  }

  function doAutoCapture(frameCanvas, cornerPoints) {
    // Extract paper (perspective corrected)
    const outW = 1200; // output size (adjust ok)
    const outH = 1700;
    const extracted = scanner.extractPaper(frameCanvas, outW, outH, cornerPoints);
    if (!extracted) throw new Error("Extraction impossible (ticket non extrait).");

    // Show preview + build PDF blob (only ticket)
    showPreviewCanvas(extracted);
    pendingPdfBlob = canvasToPdfBlob(extracted);
    pendingPdfFilename = "scan_ticket.pdf";

    el("scanPanel").classList.remove("hidden");
    el("scanOk").textContent = "Auto-capture OK — aperçu prêt. Tu peux envoyer GED + OCR.";
    el("scanErr").textContent = "";
    el("scanMeta").textContent = `Auto-capture (${outW}×${outH})`;

    // Optional: stop camera once captured to save battery
    stopCam();
  }

  /** ===== Page init ===== */
  if (isAdmin) {
    el("pageTitle").textContent = "Admin";
    el("adminBlock").classList.remove("hidden");

    el("saveAdmin").addEventListener("click", async () => {
      el("adminErr").textContent = "";
      el("adminOk").textContent = "";

      const payload = {
        baseUrl: el("baseUrl").value.trim(),
        identifiant: el("identifiant").value.trim(),
        motdepasse: el("motdepasse").value,
        codeDossier: el("codeDossier").value.trim()
      };

      try {
        const resp = await fetch("/api/admin/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const out = await resp.json();
        if (!resp.ok) throw new Error(out.error || "Erreur");
        el("adminOk").textContent = "OK — enregistré.";
      } catch (e) {
        el("adminErr").textContent = String(e.message || e);
      }
    });

    el("openDossier").addEventListener("click", async () => {
      el("adminErr").textContent = "";
      el("adminOk").textContent = "";

      const codeDossier = el("codeDossier").value.trim();
      if (!codeDossier) { el("adminErr").textContent = "Code dossier obligatoire."; return; }

      try {
        const resp = await fetch("/api/cnx/session-dossier", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ codeDossier })
        });
        const out = await resp.json();
        if (!resp.ok) throw new Error(out.error || "Erreur");
        el("adminOk").textContent = "OK — dossier ouvert.";
      } catch (e) {
        el("adminErr").textContent = String(e.message || e);
      }
    });

  } else {
    el("userBlock").classList.remove("hidden");
    if (isDebug) el("debugCard").classList.remove("hidden");

    fillCategories();
    fillVatForCurrentCategory();
    el("categorie").addEventListener("change", () => fillVatForCurrentCategory());

    (async () => {
      const cd = await loadCodeDossier();
      if (!cd) el("gedErr").textContent = "Code dossier non configuré. Va sur /?admin=1.";
    })();

    // PDF import
    el("fileInput").addEventListener("change", () => {
      resetAll();
      const f = el("fileInput").files[0];
      if (!f) return;
      pendingPdfBlob = f;
      pendingPdfFilename = f.name || "ticket.pdf";
      el("scanPanel").classList.remove("hidden");
      el("scanOk").textContent = "PDF prêt. Tu peux envoyer GED + OCR.";
      el("scanMeta").textContent = "PDF importé";
    });

    // camera buttons
    el("startCam").addEventListener("click", startCam);
    el("stopCam").addEventListener("click", stopCam);

    // clear scan
    el("clearScanBtn").addEventListener("click", () => {
      resetAll();
    });

    // upload GED + OCR
    el("uploadGed").addEventListener("click", async () => {
      el("gedErr").textContent = "";
      el("gedOk").textContent = "";
      el("err").textContent = "";
      el("ok").textContent = "";
      if (isDebug) el("debugOut").value = "";

      const codeDossier = (el("codeDossierView").value || "").trim();
      if (!codeDossier) {
        el("gedErr").textContent = "Upload bloqué : code dossier manquant. Va sur /?admin=1.";
        return;
      }
      if (!pendingPdfBlob) {
        el("gedErr").textContent = "Choisis un PDF ou utilise la caméra (auto-capture) d’abord.";
        return;
      }

      try {
        const form = new FormData();
        form.append("pdf", pendingPdfBlob, pendingPdfFilename);

        const resp = await fetch("/api/ged/upload", { method: "POST", body: form });
        const out = await resp.json();
        if (!resp.ok) throw new Error(out.error || "Erreur upload/OCR");

        el("referenceGedId").value = out.gedId;
        el("gedOk").textContent = "OK — Upload GED + OCR terminé. Id GED = " + out.gedId;

        const ex = out.extraction || {};
        if (ex.date_document) el("dateTicket").value = ex.date_document;
        if (ex.raison_sociale) el("raisonSociale").value = ex.raison_sociale;

        if (ex.numero_ticket) el("numeroTicket").value = ex.numero_ticket;
        else ensureTicketNumber();

        if (typeof ex.montant_ttc === "number") el("ttc").value = String(ex.montant_ttc).replace(".", ",");
        if (typeof ex.montant_ht === "number") el("ht").value = String(ex.montant_ht).replace(".", ",");
        if (typeof ex.montant_tva === "number") el("tvaMontant").value = String(ex.montant_tva).replace(".", ",");

        const sug = out.suggestion || {};
        if (sug.categorie_ui) setSelect(el("categorie"), sug.categorie_ui);
        fillVatForCurrentCategory();
        if (sug.tva_rate) setSelect(el("tvaRate"), sug.tva_rate);
        if (sug.compteF) setSelect(el("compteFournisseur"), sug.compteF);

        if (isDebug) el("debugOut").value = JSON.stringify(out, null, 2);

      } catch (e) {
        el("gedErr").textContent = String(e.message || e);
      }
    });

    // send ecriture
    el("submit").addEventListener("click", async () => {
      el("err").textContent = "";
      el("ok").textContent = "";
      if (isDebug) el("debugOut").value = "";

      const referenceGedId = (el("referenceGedId").value || "").trim();
      if (!referenceGedId) { el("err").textContent = "Uploade d'abord le PDF (Id GED requis)."; return; }

      const numeroTicket = ensureTicketNumber();

      const meta = {
        journal: (el("journal").value || "").trim(),
        compteFournisseur: el("compteFournisseur").value,
        referenceGedId,
        categorie_ui: el("categorie").value,
        tva_rate: el("tvaRate").value,
        date_ticket: (el("dateTicket").value || "").trim(),
        numero_ticket: numeroTicket,
        raison_sociale: (el("raisonSociale").value || "").trim(),
        montant_ttc: toNumOrNull(el("ttc").value),
        ht: toNumOrNull(el("ht").value),
        tva_montant: toNumOrNull(el("tvaMontant").value)
      };

      const form = new FormData();
      form.append("meta", JSON.stringify(meta));

      try {
        const resp = await fetch("/api/receipts/submit", { method: "POST", body: form });
        const out = await resp.json();
        if (!resp.ok) throw new Error(out.error || "Erreur envoi écriture");

        el("ok").textContent = "OK — écriture envoyée.";
        if (isDebug) el("debugOut").value = JSON.stringify(out, null, 2);
      } catch (e) {
        el("err").textContent = String(e.message || e);
      }
    });
  }
</script>
</body>
</html>
