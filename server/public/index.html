<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Tikeo - Gestion des frais</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --success: #059669;
      --error: #dc2626;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --radius: 12px;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      line-height: 1.5;
    }

    .container {
      max-width: 650px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 80px;
    }

    center img {
      max-width: 140px;
      margin-bottom: 10px;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05));
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 800;
      text-align: center;
      margin-bottom: 30px;
      letter-spacing: -0.025em;
    }

    h3 {
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: 20px;
      color: var(--primary);
    }

    .card {
      background: var(--card-bg);
      padding: 24px;
      margin-bottom: 20px;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border);
    }

    label {
      display: block;
      margin-bottom: 16px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    input, select, textarea {
      width: 100%;
      margin-top: 6px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 16px;
      background-color: #fcfcfd;
      box-sizing: border-box;
      transition: all 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      background-color: #fff;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .row > div { flex: 1; min-width: 140px; }

    button {
      width: 100%;
      padding: 14px 20px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.95rem;
      margin-top: 10px;
      transition: transform 0.1s;
    }

    button:active { transform: scale(0.98); }

    .btn-secondary { background: #64748b; }
    .btn-success { background: var(--success); }
    
    .hint { font-size: 0.75rem; color: var(--text-muted); margin-top: -10px; margin-bottom: 10px; }

    /* Cache les alertes vides */
    .error:empty, .success:empty { display: none; }
    .error, .success {
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 0.85rem;
      font-weight: 500;
      animation: fadeIn 0.3s;
    }
    .error { background: #fee2e2; color: var(--error); border: 1px solid #fecaca; }
    .success { background: #ecfdf5; color: var(--success); border: 1px solid #d1fae5; }

    .hidden { display: none; }

    #adminTrigger {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      font-size: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @media (min-width: 600px) { button { width: auto; min-width: 160px; } }
  </style>
</head>
<body>

<div class="container">
  <center><img src="http://www.image-heberg.fr/files/1771946239507659589.png" alt="Logo Tikeo"></center>
  <h1 id="pageTitle">Gestion des frais</h1>

  <div id="adminBlock" class="card hidden">
    <h3>⚙️ Configuration Admin</h3>

    <label>CNX base URL
      <input id="baseUrl" placeholder="https://isuiteacd.suiteexpert.fr/cnx/api">
    </label>

    <div class="row">
      <div>
        <label>Identifiant
          <input id="identifiant" placeholder="Identifiant">
        </label>
      </div>
      <div>
        <label>Mot de passe
          <input id="motdepasse" type="password" placeholder="••••••••">
        </label>
      </div>
    </div>

    <label>Code dossier
      <input id="codeDossier" placeholder="DA_CONSEIL">
    </label>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:20px;">
        <button id="saveAdmin">Enregistrer</button>
        <button id="openDossier" class="btn-success">Ouvrir dossier</button>
    </div>

    <div id="adminErr" class="error"></div>
    <div id="adminOk" class="success"></div>

    <hr style="margin:25px 0; border:0; border-top:1px solid var(--border);">
    <button onclick="window.location.href='?'" class="btn-secondary">← Retour à l'accueil</button>
  </div>

  <div id="userBlock" class="hidden">
    
    <div class="card">
      <h3>1️⃣ Justificatif</h3>
      <label>Dossier : <input id="codeDossierView" readonly style="display:inline-block; width:auto; border:none; background:transparent; font-weight:bold;"></label>
      
      <label>Photo ou PDF
        <input type="file" id="fileInput" accept="application/pdf,image/*" capture="environment">
      </label>

      <button id="uploadGed">Envoyer le ticket</button>
      <div id="gedErr" class="error"></div>
      <div id="gedOk" class="success"></div>
      <input id="referenceGedId" type="hidden">
    </div>

    <div class="card">
      <h3>2️⃣ Comptabilité</h3>

      <div class="row">
        <div>
          <label>Journal <input id="journal" value="AC"></label>
        </div>
        <div>
          <label>Fournisseur
            <select id="compteFournisseur">
              <option value="FREPAS">FREPAS</option>
              <option value="FCARBU">FCARBU</option>
              <option value="FPARKING">FPARKING</option>
              <option value="FPEAGE">FPEAGE</option>
              <option value="FDIVERS" selected>FDIVERS</option>
            </select>
          </label>
        </div>
      </div>

      <div class="row">
        <div><label>Catégorie <select id="categorie"></select></label></div>
        <div><label>TVA (%) <select id="tvaRate"></select></label></div>
      </div>

      <div class="row">
        <div><label>Date <input id="dateTicket" type="date"></label></div>
        <div><label>N° Ticket <input id="numeroTicket" placeholder="T0001"></label></div>
      </div>

      <label>Libellé / Raison sociale
        <input id="raisonSociale" placeholder="ex: TOTAL ACCESS">
      </label>

      <div class="row">
        <div><label>TTC (€) <input id="ttc" inputmode="decimal" placeholder="0,00"></label></div>
        <div><label>HT (€) <input id="ht" inputmode="decimal" placeholder="0,00"></label></div>
      </div>

      <label>TVA (€) <input id="tvaMontant" inputmode="decimal" placeholder="0,00"></label>

      <button id="submit">Valider l'écriture</button>
      <div id="err" class="error"></div>
      <div id="ok" class="success"></div>
    </div>

    <div id="debugCard" class="card hidden">
      <h3>Debug Output</h3>
      <textarea id="debugOut" readonly style="min-height:100px; background:#1e293b; color:#fff; font-size:11px;"></textarea>
    </div>
  </div>
</div>

<a href="?admin=1" id="adminTrigger">⚙️</a>

<script async src="https://docs.opencv.org/4.x/opencv.js"></script>

<script>
  const el = (id) => document.getElementById(id);
  const qs = new URLSearchParams(location.search);
  const isAdmin = qs.get("admin") === "1";
  
  // Routage
  if (isAdmin) {
    el("pageTitle").textContent = "Admin";
    el("adminBlock").classList.remove("hidden");
    el("adminTrigger").classList.add("hidden");
  } else {
    el("userBlock").classList.remove("hidden");
  }

  const CATEGORIES = [
    { key: "petites_fournitures", label: "Petites fournitures", vat: ["20","10"] },
    { key: "papeterie", label: "Papeterie", vat: ["20"] },
    { key: "carburant", label: "Carburant", vat: ["20"] },
    { key: "repas_pro", label: "Repas pro", vat: ["10"] },
    { key: "repas", label: "Repas (TVA 0%)", vat: ["0"] },
    { key: "peages", label: "Péages", vat: ["20"] },
    { key: "parking", label: "Parking", vat: ["20"] }
  ];

  function toNumOrNull(v){
    const s = String(v || "").trim().replace(",", ".");
    return s ? Number(s) : null;
  }

  function setSelect(selectEl, value){
    const opt = [...selectEl.options].find(o => o.value === value);
    if (opt) selectEl.value = value;
  }

  function fillCategories(){
    el("categorie").innerHTML = CATEGORIES.map(c => `<option value="${c.key}">${c.label}</option>`).join("");
  }

  function fillVatForCurrentCategory(){
    const cat = CATEGORIES.find(c => c.key === el("categorie").value);
    const allowed = cat ? cat.vat : ["20","10","0"];
    const current = el("tvaRate").value;
    el("tvaRate").innerHTML = allowed.map(v => `<option value="${v}">${v}%</option>`).join("");
    if (allowed.includes(current)) el("tvaRate").value = current;
  }

  async function loadCodeDossier(){
    try{
      const r = await fetch("/api/admin/public");
      const out = await r.json();
      el("codeDossierView").value = out.codeDossier || "Non configuré";
    } catch(e) {}
  }

  function nextTicketNumber() {
    const key = "ticket_counter_T";
    const next = Number(localStorage.getItem(key) || "0") + 1;
    localStorage.setItem(key, String(next));
    return "T" + String(next).padStart(4, "0");
  }

  // --- LOGIQUE OPENCV (CORRIGÉE) ---
  function scanTicketOpenCV(srcCanvas) {
    let src = cv.imread(srcCanvas);
    let gray = new cv.Mat(), blur = new cv.Mat(), edges = new cv.Mat();
    let contours = new cv.MatVector(), hierarchy = new cv.Mat();
    let finalCanvas = srcCanvas;

    try {
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
      cv.GaussianBlur(gray, blur, new cv.Size(5, 5), 0);
      cv.Canny(blur, edges, 75, 200);
      cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

      let maxArea = 0, bestCnt = null;
      for (let i = 0; i < contours.size(); i++) {
        let cnt = contours.get(i);
        let area = cv.contourArea(cnt);
        let peri = cv.arcLength(cnt, true);
        let approx = new cv.Mat();
        cv.approxPolyDP(cnt, approx, 0.02 * peri, true);
        if (approx.rows === 4 && area > maxArea) {
          maxArea = area;
          if (bestCnt) bestCnt.delete();
          bestCnt = approx;
        } else { approx.delete(); }
      }

      if (bestCnt && maxArea > (src.rows * src.cols * 0.1)) {
        // Simple perspective warp logic
        finalCanvas = document.createElement("canvas");
        cv.imshow(finalCanvas, src); // Simplifié pour éviter erreurs mémoires complexes
      }
      if (bestCnt) bestCnt.delete();
    } catch (e) { console.error(e); }

    // Nettoyage manuel OpenCV
    src.delete(); gray.delete(); blur.delete(); edges.delete(); contours.delete(); hierarchy.delete();
    return finalCanvas;
  }

  async function imageFileToPdfBlob(file) {
    if (!window.cv || !cv.Mat) return file; 
    const img = new Image();
    img.src = URL.createObjectURL(file);
    await new Promise(r => img.onload = r);
    const c = document.createElement("canvas");
    c.width = img.width; c.height = img.height;
    c.getContext("2d").drawImage(img, 0, 0);
    const processed = scanTicketOpenCV(c);
    const dataUrl = processed.toDataURL("image/jpeg", 0.8);
    return fetch(dataUrl).then(r => r.blob());
  }

  if (isAdmin) {
    el("saveAdmin").onclick = async () => {
      const data = { baseUrl: el("baseUrl").value, identifiant: el("identifiant").value, motdepasse: el("motdepasse").value, codeDossier: el("codeDossier").value };
      const r = await fetch("/api/admin/config", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(data) });
      if(r.ok) el("adminOk").textContent = "Config sauvegardée.";
    };
    el("openDossier").onclick = async () => {
      const r = await fetch("/api/cnx/session-dossier", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({codeDossier: el("codeDossier").value}) });
      if(r.ok) el("adminOk").textContent = "Dossier ouvert.";
    };
  } else {
    fillCategories(); fillVatForCurrentCategory();
    el("categorie").onchange = fillVatForCurrentCategory;
    loadCodeDossier();

    el("uploadGed").onclick = async () => {
      el("gedErr").textContent = ""; el("gedOk").textContent = "Analyse...";
      const file = el("fileInput").files[0];
      if (!file) return el("gedErr").textContent = "Fichier manquant.";
      try {
        const blob = file.type.includes("image") ? await imageFileToPdfBlob(file) : file;
        const fd = new FormData(); fd.append("pdf", blob, "doc.pdf");
        const r = await fetch("/api/ged/upload", { method: "POST", body: fd });
        const out = await r.json();
        if (!r.ok) throw new Error(out.error);
        
        el("referenceGedId").value = out.gedId;
        el("gedOk").textContent = "Ticket chargé.";
        const ex = out.extraction || {};
        el("dateTicket").value = ex.date_document || "";
        el("raisonSociale").value = ex.raison_sociale || "";
        el("numeroTicket").value = ex.numero_ticket || nextTicketNumber();
        el("ttc").value = String(ex.montant_ttc || "").replace(".", ",");
        el("ht").value = String(ex.montant_ht || "").replace(".", ",");
        el("tvaMontant").value = String(ex.montant_tva || "").replace(".", ",");
        if(out.suggestion?.categorie_ui) setSelect(el("categorie"), out.suggestion.categorie_ui);
        fillVatForCurrentCategory();
      } catch (e) { el("gedErr").textContent = e.message; el("gedOk").textContent = ""; }
    };

    el("submit").onclick = async () => {
      const meta = { referenceGedId: el("referenceGedId").value, journal: el("journal").value, compteFournisseur: el("compteFournisseur").value, date_ticket: el("dateTicket").value, numero_ticket: el("numeroTicket").value || nextTicketNumber(), raison_sociale: el("raisonSociale").value, montant_ttc: toNumOrNull(el("ttc").value), ht: toNumOrNull(el("ht").value), tva_montant: toNumOrNull(el("tvaMontant").value) };
      const fd = new FormData(); fd.append("meta", JSON.stringify(meta));
      const r = await fetch("/api/receipts/submit", { method: "POST", body: fd });
      if(r.ok) el("ok").textContent = "Écriture validée !";
      else el("err").textContent = "Erreur lors de l'envoi.";
    };
  }
</script>
</body>
</html>
